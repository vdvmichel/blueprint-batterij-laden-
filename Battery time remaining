blueprint:
  name: Battery Time Remaining Calculation
  description: Bereken de tijd die overblijft voordat de batterij vol of leeg is.
  domain: automation
  input:
    battery_capacity:
      name: Batterij Capaciteit
      description: Selecteer de sensor die de totale capaciteit van de batterij weergeeft (in Wh).
      selector:
        entity:
          domain: sensor
    battery_soc:
      name: Batterij State of Charge (SoC)
      description: Selecteer de sensor die het huidige state of charge van de batterij weergeeft (in %).
      selector:
        entity:
          domain: sensor
    battery_power:
      name: Batterij Laad/ontlaad Vermogen
      description: Selecteer de sensor die het huidige laad- of ontlaadvermogen van de batterij weergeeft (in W).
      selector:
        entity:
          domain: sensor
    time_until_full:
      name: Tijd tot Vol
      description: Helper voor de berekende tijd tot de batterij vol is.
      default: 
        name: Time Until Full
        min: 0
        max: 24
        step: 0.1
        unit_of_measurement: uren
      selector:
        number:
          min: 0
          max: 24
          step: 0.1
          unit_of_measurement: h
    time_until_empty:
      name: Tijd tot Leeg
      description: Helper voor de berekende tijd tot de batterij leeg is.
      default: 
        name: Time Until Empty
        min: 0
        max: 24
        step: 0.1
        unit_of_measurement: uren
      selector:
        number:
          min: 0
          max: 24
          step: 0.1
          unit_of_measurement: h

trigger:
  - platform: state
    entity_id: !input battery_power

action:
  - variables:
      capacity_wh: "{{ states(input.battery_capacity) | float }}"
      soc_percentage: "{{ states(input.battery_soc) | float }}"
      power_w: "{{ states(input.battery_power) | float }}"
      current_energy: "{{ (capacity_wh * (soc_percentage / 100)) }}"

  - choose:
      - conditions:
          - condition: template
            value_template: "{{ power_w > 0 }}"
        sequence:
          - service: input_number.set_value
            target:
              entity_id: !input time_until_full
            data:
              value: "{{ ((capacity_wh - current_energy) / power_w) | round(2) }}"

      - conditions:
          - condition: template
            value_template: "{{ power_w < 0 }}"
        sequence:
          - service: input_number.set_value
            target:
              entity_id: !input time_until_empty
            data:
              value: "{{ (current_energy / abs(power_w)) | round(2) }}"
